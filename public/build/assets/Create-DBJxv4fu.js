import{a as ve,r as u,u as ge,t as o,j as e,H as _e,L as Ne,d as be}from"./app-BiR3H72c.js";import{A as Se}from"./app-layout-DXRwYbWn.js";import{B as _}from"./button-DfBT4842.js";import{I as A}from"./input-CBAXjYrY.js";import{L as E}from"./label-C35PAQno.js";import{S as ye,a as we,b as Ce,c as Te,d as ke}from"./select-B5KxOem9.js";import{B as N}from"./badge-NokOUrZG.js";import{C as R,a as J,b as K,d as V,e as Fe}from"./card-CtX8457h.js";import{S as $}from"./scroll-area-iQk4GMsN.js";import{T as Ie,a as Pe,b as W,c as Y}from"./tabs-DEApmZXv.js";import{X as qe,S as Le}from"./breadcrumbs-CfH9HSk2.js";import{d as Z,C as Ae}from"./ClientManager-C0a7QIEG.js";import{T as ee,a as se,b as C,c as j,d as te,e as f}from"./table-CMAMKCJS.js";import{C as Ee}from"./chevron-left-CImlN05b.js";import{S as Re}from"./search-D5WKme3c.js";import{P as re}from"./plus-BhylbLjU.js";import{S as ae}from"./shopping-cart-CtXjzZ1W.js";import{T as Ve}from"./trash-ytvtsJAQ.js";import"./app-BojVexQw.js";import"./index-C4BIJOdj.js";import"./index-DL4BAlbN.js";import"./index-CaoPq-lK.js";import"./index-CHBa3DK4.js";import"./index-DZfrvXPy.js";import"./chevron-down-C8aG4wQu.js";import"./index-D85psPK1.js";import"./createLucideIcon-AVJzoGs5.js";import"./utils-D-KgF5mV.js";import"./chevrons-up-down-D26-hiHV.js";import"./app-logo-icon-D1TxLKab.js";import"./calendar-CQ4TJ2Ye.js";import"./package-CMie0C_N.js";import"./circle-alert-CxFuhzFA.js";import"./index-DufLrpEQ.js";import"./index-BdQq_4o_.js";import"./index-Di7OUUGl.js";import"./index-D-SBhKFM.js";import"./check-DVZ7LPyx.js";import"./index-C-wqcDA1.js";import"./index-DZGh8cYj.js";import"./chevron-right-F_DONt-v.js";import"./dialog-C2xpyM_9.js";import"./example-date-picker-CijpV8RP.js";import"./calendar-Bm37FrpH.js";import"./DayPicker-BNzRSgUN.js";import"./format-B6qNwQQI.js";import"./popover-B0R-MFpt.js";import"./fr-CLbTb0XB.js";const $e=[{title:"Dashboard",href:"/dashboard"},{title:"Ventes",href:"/ventes"},{title:"Nouvelle vente",href:"/ventes/create"}],ie=1e-13;function As({auth:b,configuration:S}){var O;const{clients:p,succursales:T,produits:k,services:F}=ve().props,I=b.user.succursale_id,[ne,w]=u.useState(!1),{data:r,setData:v,post:le,processing:P,reset:U}=ge({client_id:"",quantite:1,succursale_id:I||"",remise_montant:0,remise:0,remise_pourcentage:0,montant_total:0,mode_paiement:"espèces",items:[]}),oe={espèces:{value:"espèces",label:"Espèces"},carte:{value:"carte",label:"Carte"},chèque:{value:"chèque",label:"Chèque"},autre:{value:"autre",label:"Points de fidélité"}},[l,q]=u.useState(null),[D,ce]=u.useState(""),[L,de]=u.useState(""),z=(s,t)=>s*(t/100),[me,Ue]=u.useState(0),H=k==null?void 0:k.filter(s=>s.name.toLowerCase().includes(D.toLowerCase())).map(s=>{var i;const t=(i=s.stock_succursales)==null?void 0:i.find(n=>n.succursale_id===I);return{...s,stock_disponible:t?t.quantite:0}}),B=F==null?void 0:F.filter(s=>s.name.toLowerCase().includes(D.toLowerCase())).map(s=>({...s,stock_disponible:null}));p==null||p.filter(s=>s.name.toLowerCase().includes(L.toLowerCase())||s.email&&s.email.toLowerCase().includes(L.toLowerCase())||s.telephone&&s.telephone.toLowerCase().includes(L.toLowerCase())),u.useEffect(()=>{(()=>{const t=r.items.filter(c=>c.type==="produit"),i=r.items.filter(c=>c.type==="service"),n=t.reduce((c,m)=>c+parseFloat(m.montant_total.toString()),0),a=n*ie,x=n+a,d=i.reduce((c,m)=>c+parseFloat(m.montant_total.toString()),0),h=x+d,g=r.remise_pourcentage>0?z(h,r.remise_pourcentage):r.remise_montant,y=Math.max(h-g,0);(r.montant_total!==y||r.remise!==g)&&v(c=>({...c,montant_total:y,remise:g,remise_montant:g}))})()},[r.items,r.remise_pourcentage]),u.useEffect(()=>{if(r.client_id){const s=p==null?void 0:p.find(t=>t.id.toString()===r.client_id);s&&q(s)}else q(null)},[r.client_id,p]);const M=u.useCallback((s,t)=>{if(t==="produit"){if(s.stock_disponible<=0){o.error("Stock insuffisant pour ce produit");return}if(r.items.filter(a=>a.produit_id===s.id.toString()).reduce((a,x)=>a+x.quantite,0)>=s.stock_disponible){o.error("Quantité demandée dépasse le stock disponible");return}}const i=r.items.findIndex(n=>t==="produit"&&n.produit_id===s.id.toString()||t==="service"&&n.service_id===s.id.toString());if(i!==-1){const n=[...r.items],a=n[i];n[i]={...a,quantite:a.quantite+1,montant_total:a.prix_unitaire*(a.quantite+1)-(a.remise_montant||0)},v("items",n),o.success(`Quantité de ${s.name} augmentée`)}else{const n={[t==="produit"?"produit_id":"service_id"]:s.id.toString(),quantite:1,prix_unitaire:t==="produit"?s.prix_vente:s.prix,remise:0,remise_montant:0,remise_pourcentage:0,montant_total:t==="produit"?s.prix_vente:s.prix,type:t,nom:s.name,stock_disponible:t==="produit"?s.stock_disponible:void 0};v("items",[...r.items,n]),o.success(`${s.name} ajouté au panier`)}},[r.items]),ue=s=>{const t=[...r.items];t.splice(s,1),v("items",t)},Q=(s,t,i)=>{var g,y,c;const n=[...r.items],a={...n[s]};if(a.remise_montant=a.remise_montant??0,a.remise_pourcentage=a.remise_pourcentage??0,a[t]=i,t==="remise_pourcentage"){const m=parseFloat(i)||0;a.remise_montant=z(a.prix_unitaire*a.quantite,m),a.remise_pourcentage=m}if(t==="remise_montant"){const m=parseFloat(i)||0,X=a.prix_unitaire*a.quantite;a.remise_pourcentage=X>0?m/X*100:0,a.remise_montant=m}const x=parseInt(((g=a.quantite)==null?void 0:g.toString())||"1"),d=parseFloat(((y=a.prix_unitaire)==null?void 0:y.toString())||"0"),h=parseFloat(((c=a.remise_montant)==null?void 0:c.toString())||"0");a.montant_total=Math.max(d*x-h,0),n[s]=a,v("items",n)},pe=Z(s=>{ce(s)},300);Z(s=>{de(s)},300);const G=s=>{if(s.preventDefault(),!r.client_id){o.error("Veuillez sélectionner un client");return}if(r.items.length===0){o.error("Veuillez ajouter au moins un produit ou service");return}le(route("ventes.store"),{onSuccess:async()=>{o.success("Vente enregistrée avec succès"),U();const t=await xe();if(t){const i=route("ventes.print",{vente:t});window.open(i,"_blank")}else o.error("Impossible de récupérer l'ID de la vente.")},onError:t=>{console.error("Erreurs:",t),t.items?o.error("Erreur avec les articles du panier"):t.client_id?o.error(t.client_id):o.error("Erreur lors de l'enregistrement de la vente")}})},xe=async()=>{try{return(await be.get(route("get-recent-vente"),{params:{vendeur_id:b.user.id}})).data}catch(s){return console.error("Erreur lors de la récupération des ventes :",s),null}},he=()=>{const s=r.items.filter(d=>d.type==="produit"),t=r.items.filter(d=>d.type==="service"),i=s.reduce((d,h)=>d+parseFloat(h.montant_total.toString()),0),n=i*ie,a=i+n,x=t.reduce((d,h)=>d+parseFloat(h.montant_total.toString()),0);return{totalProduitsHT:i,tvaProduitsAmount:n,totalProduitsTTC:a,totalServices:x,sousTotal:a+x}},je=()=>{U()},fe=b.promotion!==0;return u.useEffect(()=>{var s,t,i;r.mode_paiement==="autre"?l&&((s=l==null?void 0:l.fidelite)!=null&&s.points&&((t=l==null?void 0:l.fidelite)==null?void 0:t.points)<S.seuil_utilisation?w(!1):r.montant_total>((i=l==null?void 0:l.fidelite)==null?void 0:i.points)*S.valeur_point?(w(!1),o.error("Le montant de la vente est supérieur au montant des points disponibles")):(w(!0),o.success("Le client a assez de points pour payer la vente"))):w(!1)},[r.mode_paiement]),e.jsxs(Se,{auth:b,breadcrumbs:$e,children:[e.jsx(_e,{title:"Nouvelle vente"}),e.jsxs("div",{className:"flex flex-1 flex-col gap-4 p-4 md:gap-8 md:p-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(Ne,{href:route("ventes.index"),children:e.jsx(_,{variant:"outline",size:"icon",children:e.jsx(Ee,{className:"h-4 w-4"})})}),e.jsx("h1",{className:"text-2xl font-bold tracking-tight",children:"Nouvelle vente"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(N,{variant:"outline",className:"px-3 py-1",children:["Branche: ",((O=T==null?void 0:T.find(s=>s.id===I))==null?void 0:O.nom)||"Non définie"]}),e.jsxs(N,{variant:"outline",className:"px-3 py-1",children:["Vendeur: ",b.user.name]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-12 gap-6",children:[e.jsx("div",{className:"lg:col-span-8 space-y-6",children:e.jsxs(R,{children:[e.jsx(J,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(K,{children:"Catalogue"}),e.jsxs("div",{className:"relative w-full max-w-sm",children:[e.jsx(Re,{className:"absolute left-3 top-3 h-4 w-4 text-muted-foreground"}),e.jsx(A,{placeholder:"Rechercher un produit ou service...",className:"pl-9",onChange:s=>pe(s.target.value)})]})]})}),e.jsx(V,{className:"p-0",children:e.jsxs(Ie,{defaultValue:"produits",className:"w-full",children:[e.jsx("div",{className:"px-6",children:e.jsxs(Pe,{className:"w-full",children:[e.jsx(W,{value:"produits",className:"flex-1",children:"Produits"}),e.jsx(W,{value:"services",className:"flex-1",children:"Services"})]})}),e.jsx(Y,{value:"produits",className:"m-0",children:e.jsx($,{className:"h-[500px] px-6 py-4",children:H.length>0?e.jsx("div",{className:"border rounded-lg",children:e.jsxs(ee,{children:[e.jsx(se,{children:e.jsxs(C,{children:[e.jsx(j,{className:"w-[200px]",children:"Produit"}),e.jsx(j,{children:"Stock"}),e.jsx(j,{children:"Prix"}),e.jsx(j,{className:"text-right",children:"Actions"})]})}),e.jsx(te,{children:H.map(s=>e.jsxs(C,{className:s.stock_disponible<=0?"opacity-60":"",children:[e.jsx(f,{className:"font-medium",children:s.name}),e.jsx(f,{children:e.jsx(N,{variant:s.stock_disponible>0?"success":"destructive",children:s.stock_disponible})}),e.jsx(f,{children:new Intl.NumberFormat("fr-FR",{style:"currency",currency:"USD"}).format(s.prix_vente).replace("$US","$ ")}),e.jsx(f,{className:"text-right",children:e.jsxs(_,{size:"sm",variant:"secondary",onClick:()=>M(s,"produit"),disabled:me>=s.stock_disponible,children:[e.jsx(re,{className:"h-4 w-4 mr-2"}),"Ajouter ",s.stock_disponible]})})]},s.id))})]})}):e.jsx("div",{className:"text-center py-8",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aucun produit trouvé"})})})}),e.jsx(Y,{value:"services",className:"m-0",children:e.jsx($,{className:"h-[500px] px-6 py-4",children:B.length>0?e.jsx("div",{className:"border rounded-lg",children:e.jsxs(ee,{children:[e.jsx(se,{children:e.jsxs(C,{children:[e.jsx(j,{className:"w-[200px]",children:"Service"}),e.jsx(j,{children:"Durée"}),e.jsx(j,{children:"Prix"}),e.jsx(j,{className:"text-right",children:"Actions"})]})}),e.jsx(te,{children:B.map(s=>e.jsxs(C,{children:[e.jsx(f,{className:"font-medium",children:e.jsxs("div",{children:[s.name,s.description&&e.jsx("p",{className:"text-sm text-muted-foreground mt-1 line-clamp-1",children:s.description.slice(0,20)+"..."})]})}),e.jsx(f,{children:e.jsxs(N,{variant:"outline",children:[s.duree_minutes," min"]})}),e.jsx(f,{children:new Intl.NumberFormat("fr-FR",{style:"currency",currency:"USD"}).format(s.prix).replace("$US","$ ")}),e.jsx(f,{className:"text-right",children:e.jsxs(_,{size:"sm",variant:"secondary",onClick:()=>M(s,"service"),children:[e.jsx(re,{className:"h-4 w-4 mr-2"}),"Ajouter"]})})]},s.id))})]})}):e.jsx("div",{className:"text-center py-8",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aucun service trouvé"})})})})]})})]})}),e.jsx("div",{className:"lg:col-span-4 space-y-6",children:e.jsxs(R,{className:"flex flex-col",children:[e.jsxs(J,{className:"pb-3 flex items-center justify-between",children:[e.jsxs(K,{className:"flex items-center",children:[e.jsx(ae,{className:"h-5 w-5 mr-2"}),"Panier (",r.items.length,")"]}),r.items.length>0&&e.jsxs(_,{size:"sm",variant:"destructive",onClick:je,children:[e.jsx(Ve,{className:"h-4 w-4 mr-2"}),"Vider"]})]}),e.jsx(V,{children:e.jsx($,{className:"flex-1 max-h-[350px] pr-4 overflow-y-auto",children:r.items.length>0?e.jsx("div",{className:"space-y-2",children:r.items.map((s,t)=>e.jsx(R,{className:"overflow-hidden p-1",children:e.jsxs(V,{className:"p-1",children:[e.jsxs("div",{className:"flex justify-between items-start mb-3",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium",children:s.nom}),e.jsx(N,{variant:s.type==="produit"?"default":"secondary",className:"mt-1",children:s.type==="produit"?"Produit":"Service"})]}),e.jsx(_,{variant:"ghost",size:"sm",onClick:()=>ue(t),children:e.jsx(qe,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(E,{className:"text-xs",children:"Quantité"}),e.jsx(A,{type:"number",min:"1",max:s.type==="produit"?s.stock_disponible:void 0,value:s.quantite,onChange:i=>Q(t,"quantite",parseInt(i.target.value)),className:"w-full"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(E,{className:"text-xs",children:"Prix unitaire"}),e.jsx(A,{type:"text",disabled:!fe,value:s.prix_unitaire,onChange:i=>Q(t,"prix_unitaire",parseFloat(i.target.value)),className:"w-full"})]})]}),e.jsxs("div",{className:"mt-3 flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Sous-total"}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("fr-FR",{style:"currency",currency:"USD"}).format(s.montant_total).replace("$US","$ ")})]})]})},t))}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(ae,{className:"h-8 w-8 mx-auto text-muted-foreground"}),e.jsx("p",{className:"mt-2 text-sm text-muted-foreground",children:"Votre panier est vide"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Ajoutez des produits ou services"})]})})}),r.items.length>0&&e.jsxs(Fe,{className:"flex flex-col border-t mt-auto",children:[e.jsxs("div",{className:"w-full space-y-3 py-3",children:[(()=>{const s=he();return e.jsxs(e.Fragment,{children:[s.totalProduitsHT>0&&e.jsx(e.Fragment,{}),s.totalServices>0&&e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"Services"}),e.jsx("span",{children:new Intl.NumberFormat("fr-FR",{style:"currency",currency:"USD"}).format(s.totalServices).replace("$US","$ ")})]}),e.jsxs("div",{className:"flex justify-between font-medium",children:[e.jsx("span",{children:"Sous-total"}),e.jsx("span",{children:new Intl.NumberFormat("fr-FR",{style:"currency",currency:"USD"}).format(s.sousTotal).replace("$US","$ ")})]})]})})(),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(E,{htmlFor:"mode_paiement",children:"Mode de paiement"}),e.jsxs(ye,{value:r.mode_paiement,onValueChange:s=>v("mode_paiement",s),children:[e.jsx(we,{children:e.jsx(Ce,{placeholder:"Sélectionnez un mode de paiement"})}),e.jsx(Te,{children:Object.values(oe).map(s=>e.jsx(ke,{value:s.value,children:s.label},s.value))})]})]}),e.jsx(Le,{}),e.jsxs("div",{className:"flex justify-between font-bold text-lg",children:[e.jsx("span",{children:"Total"}),e.jsx("span",{children:new Intl.NumberFormat("fr-FR",{style:"currency",currency:"USD"}).format(parseFloat(r.montant_total.toString())).replace("$US","$ ")})]})]}),e.jsx("div",{className:"flex",children:e.jsx(Ae,{onClientSelected:s=>{q(s),v("client_id",s.id.toString())},currentClientId:r.client_id,clients:p})}),r.mode_paiement==="autre"&&e.jsx(_,{className:"w-full mt-2",type:"submit",onClick:G,disabled:!ne,children:P?"Enregistrement...":"Valider la vente"}),r.mode_paiement!=="autre"&&e.jsx(_,{className:"w-full mt-2",type:"submit",onClick:G,disabled:P||r.items.length===0||!r.client_id,children:P?"Enregistrement...":"Valider la vente"}),l&&e.jsxs("div",{className:" w-full space-y-1 py-3 bg-muted/50 p-3 rounded-md mt-2",children:[e.jsx("p",{className:"font-medium",children:"Client sélectionné : "}),e.jsx("p",{children:l.name}),l.telephone&&e.jsx("p",{className:"text-sm",children:l.telephone}),l.fidelite&&e.jsxs(N,{variant:S.seuil_utilisation>l.fidelite.points?"destructive":"secondary",className:S.seuil_utilisation>l.fidelite.points?"bg-red-500":"bg-blue-500",children:["Points : ",l.fidelite.points," vaut ",l.fidelite.points*S.valeur_point," $"]})]})]})]})})]})]})]})}export{As as default};
