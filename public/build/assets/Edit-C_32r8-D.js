import{a as je,u as fe,r as v,t as u,j as e,H as _e,L as ge,b as ve}from"./app-BiR3H72c.js";import{A as Ne}from"./app-layout-DXRwYbWn.js";import{B as N}from"./button-DfBT4842.js";import{I as A}from"./input-CBAXjYrY.js";import{L as q}from"./label-C35PAQno.js";import{S as be,a as Se,b as ye,c as we,d as Te}from"./select-B5KxOem9.js";import{B as b}from"./badge-NokOUrZG.js";import{C as $,a as X,b as J,d as U,e as Ce}from"./card-CtX8457h.js";import{S as D}from"./scroll-area-iQk4GMsN.js";import{T as Fe,a as ke,b as K,c as W}from"./tabs-DEApmZXv.js";import{X as Ie,S as Pe}from"./breadcrumbs-CfH9HSk2.js";import{d as Ae,C as qe}from"./ClientManager-C0a7QIEG.js";import{T as Y,a as Z,b as k,c as j,d as ee,e as f}from"./table-CMAMKCJS.js";import{A as $e,b as Ue,a as De}from"./alert-CJytHgmU.js";import{C as Re}from"./chevron-left-CImlN05b.js";import{c as Ve}from"./createLucideIcon-AVJzoGs5.js";import{S as Ee}from"./search-D5WKme3c.js";import{P as se}from"./plus-BhylbLjU.js";import{S as te}from"./shopping-cart-CtXjzZ1W.js";import{T as ze}from"./trash-ytvtsJAQ.js";import{f as Le}from"./format-B6qNwQQI.js";import{f as He}from"./fr-CLbTb0XB.js";import"./app-BojVexQw.js";import"./index-C4BIJOdj.js";import"./index-DL4BAlbN.js";import"./index-CaoPq-lK.js";import"./index-CHBa3DK4.js";import"./index-DZfrvXPy.js";import"./chevron-down-C8aG4wQu.js";import"./index-D85psPK1.js";import"./utils-D-KgF5mV.js";import"./chevrons-up-down-D26-hiHV.js";import"./app-logo-icon-D1TxLKab.js";import"./calendar-CQ4TJ2Ye.js";import"./package-CMie0C_N.js";import"./circle-alert-CxFuhzFA.js";import"./index-DufLrpEQ.js";import"./index-BdQq_4o_.js";import"./index-Di7OUUGl.js";import"./index-D-SBhKFM.js";import"./check-DVZ7LPyx.js";import"./index-C-wqcDA1.js";import"./index-DZGh8cYj.js";import"./chevron-right-F_DONt-v.js";import"./dialog-C2xpyM_9.js";import"./example-date-picker-CijpV8RP.js";import"./calendar-Bm37FrpH.js";import"./DayPicker-BNzRSgUN.js";import"./popover-B0R-MFpt.js";/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Me=[["path",{d:"M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1m0v6g"}],["path",{d:"M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z",key:"ohrbg2"}]],Be=Ve("SquarePen",Me),R=.16;function Ls({auth:S,vente:c}){var B,O,Q;const{clients:re,succursales:I,produits:g,services:P,modes_paiement:ie}=je().props,y=S.user.succursale_id,ae=[{title:"Dashboard",href:"/dashboard"},{title:"Ventes",href:"/ventes"},{title:`Éditer vente #${c.ref}`,href:`/ventes/${c.id}/edit`}],V=s=>s.map(t=>{var n,a,r,l,o,m,p;return{id:t.id,produit_id:((n=t.produit_id)==null?void 0:n.toString())||null,service_id:((a=t.service_id)==null?void 0:a.toString())||null,quantite:t.quantite,prix_unitaire:parseFloat(t.prix_unitaire),remise:parseFloat(t.remise)||0,remise_montant:parseFloat(t.remise)||0,remise_pourcentage:parseFloat(t.remise)/(parseFloat(t.prix_unitaire)*t.quantite)*100||0,montant_total:parseFloat(t.montant_total),type:t.produit_id?"produit":"service",nom:((r=t.produit)==null?void 0:r.name)||((l=t.service)==null?void 0:l.name)||"Article supprimé",stock_disponible:(p=(m=(o=t.produit)==null?void 0:o.stock_succursales)==null?void 0:m.find(_=>_.succursale_id===y))==null?void 0:p.quantite}}),{data:i,setData:h,put:ne,processing:E}=fe({client_id:((B=c.client_id)==null?void 0:B.toString())||"",succursale_id:c.succursale_id||y||"",remise_montant:parseFloat(c.remise)||0,remise:parseFloat(c.remise)||0,remise_pourcentage:0,montant_total:parseFloat(c.montant_total)||0,mode_paiement:c.mode_paiement||"espèces",items:V(c.items||[])}),[w,le]=v.useState(c.client||null),[z,ce]=v.useState(""),[Oe,oe]=v.useState({}),L=(s,t)=>s*(t/100);v.useEffect(()=>{const s={};i.items.forEach(t=>{var n;if(t.type==="produit"&&t.produit_id){const a=g==null?void 0:g.find(r=>r.id.toString()===t.produit_id);if(a){const r=(n=a.stock_succursales)==null?void 0:n.find(l=>l.succursale_id===y);s[t.produit_id]=((r==null?void 0:r.quantite)||0)+t.quantite}}}),oe(s)},[]);const T=g==null?void 0:g.filter(s=>s.name.toLowerCase().includes(z.toLowerCase())).map(s=>{var r;const t=(r=s.stock_succursales)==null?void 0:r.find(l=>l.succursale_id===y);let n=t?t.quantite:0;const a=i.items.filter(l=>l.produit_id===s.id.toString()).reduce((l,o)=>l+o.quantite,0);return n+=a,{...s,stock_disponible:n}}),C=P==null?void 0:P.filter(s=>s.name.toLowerCase().includes(z.toLowerCase())).map(s=>({...s,stock_disponible:null}));v.useEffect(()=>{(()=>{const t=i.items.filter(d=>d.type==="produit"),n=i.items.filter(d=>d.type==="service"),a=t.reduce((d,x)=>d+x.montant_total,0),r=a*R,l=a+r,o=n.reduce((d,x)=>d+x.montant_total,0),m=l+o,p=i.remise_pourcentage>0?L(m,i.remise_pourcentage):i.remise_montant,_=Math.max(m-p,0);(i.montant_total!==_||i.remise!==p)&&h(d=>({...d,montant_total:_,remise:p,remise_montant:p}))})()},[i.items,i.remise_pourcentage,i.remise_montant]);const H=v.useCallback((s,t)=>{if(t==="produit"){if(s.stock_disponible<=0){u.error("Stock insuffisant pour ce produit");return}if(i.items.filter(r=>r.produit_id===s.id.toString()).reduce((r,l)=>r+l.quantite,0)>=s.stock_disponible){u.error("Quantité demandée dépasse le stock disponible");return}}const n=i.items.findIndex(a=>t==="produit"&&a.produit_id===s.id.toString()||t==="service"&&a.service_id===s.id.toString());if(n!==-1){const a=[...i.items],r=a[n];a[n]={...r,quantite:r.quantite+1,montant_total:r.prix_unitaire*(r.quantite+1)-(r.remise_montant||0)},h("items",a),u.success(`Quantité de ${s.name} augmentée`)}else{const a={[t==="produit"?"produit_id":"service_id"]:s.id.toString(),quantite:1,prix_unitaire:t==="produit"?s.prix_vente:s.prix,remise:0,remise_montant:0,remise_pourcentage:0,montant_total:t==="produit"?s.prix_vente:s.prix,type:t,nom:s.name,stock_disponible:t==="produit"?s.stock_disponible:void 0};h("items",[...i.items,a]),u.success(`${s.name} ajouté au panier`)}},[i.items]),de=s=>{const t=[...i.items];t.splice(s,1),h("items",t)},M=(s,t,n)=>{var p,_,d;const a=[...i.items],r={...a[s]};if(r.remise_montant=r.remise_montant??0,r.remise_pourcentage=r.remise_pourcentage??0,r[t]=n,t==="remise_pourcentage"){const x=parseFloat(n)||0;r.remise_montant=L(r.prix_unitaire*r.quantite,x),r.remise_pourcentage=x}if(t==="remise_montant"){const x=parseFloat(n)||0,G=r.prix_unitaire*r.quantite;r.remise_pourcentage=G>0?x/G*100:0,r.remise_montant=x}const l=parseInt(((p=r.quantite)==null?void 0:p.toString())||"1"),o=parseFloat(((_=r.prix_unitaire)==null?void 0:_.toString())||"0"),m=parseFloat(((d=r.remise_montant)==null?void 0:d.toString())||"0");r.montant_total=Math.max(o*l-m,0),a[s]=r,h("items",a)},me=Ae(s=>{ce(s)},300),ue=s=>{if(s.preventDefault(),!i.client_id){u.error("Veuillez sélectionner un client");return}if(i.items.length===0){u.error("Veuillez ajouter au moins un produit ou service");return}ne(route("ventes.update",c.id),{onSuccess:()=>{u.success("Vente modifiée avec succès"),ve.visit(route("ventes.index"))},onError:t=>{console.error("Erreurs:",t),t.items?u.error("Erreur avec les articles du panier"):t.client_id?u.error(t.client_id):u.error("Erreur lors de la modification de la vente")}})},pe=()=>{const s=i.items.filter(o=>o.type==="produit"),t=i.items.filter(o=>o.type==="service"),n=s.reduce((o,m)=>o+m.montant_total,0),a=n*R,r=n+a,l=t.reduce((o,m)=>o+m.montant_total,0);return{totalProduitsHT:n,tvaProduitsAmount:a,totalProduitsTTC:r,totalServices:l,sousTotal:r+l}},xe=()=>{h("items",V(c.items||[])),u.info("Panier réinitialisé aux valeurs originales")},he=S.user.role==="gerant",F=S.user.role==="admin";return e.jsxs(Ne,{auth:S,breadcrumbs:ae,children:[e.jsx(_e,{title:`Éditer vente #${c.ref}`}),e.jsxs("div",{className:"flex flex-1 flex-col gap-4 p-4 md:gap-8 md:p-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(ge,{href:route("ventes.index"),children:e.jsx(N,{variant:"outline",size:"icon",children:e.jsx(Re,{className:"h-4 w-4"})})}),e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold tracking-tight",children:["Éditer vente #",c.ref]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Créée le ",Le(new Date(c.created_at),"PPp",{locale:He})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(b,{variant:"outline",className:"px-3 py-1",children:["Branche: ",((O=I==null?void 0:I.find(s=>s.id===y))==null?void 0:O.nom)||"Non définie"]}),e.jsxs(b,{variant:"outline",className:"px-3 py-1",children:["Vendeur: ",((Q=c.vendeur)==null?void 0:Q.name)||S.user.name]})]})]}),e.jsxs("div",{className:`${F?"grid":"mt-3 w-96  justify-center"} grid-cols-1 lg:grid-cols-12 gap-6`,children:[e.jsxs("div",{className:"lg:col-span-8 space-y-6",children:[he&&e.jsxs($e,{variant:"destructive",className:"mb-2",children:[e.jsx(Ue,{children:"Attention"}),e.jsxs(De,{children:[e.jsx("p",{children:"Vous n'avez pas le droit d'ajouter des produits ou services."}),e.jsx("p",{children:"Vous pouvez seulement modifier le prix des produits ou services."})]})]}),F&&e.jsxs($,{children:[e.jsx(X,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(J,{className:"flex items-center",children:[e.jsx(Be,{className:"h-5 w-5 mr-2"}),"Modifier le catalogue"]}),e.jsxs("div",{className:"relative w-full max-w-sm",children:[e.jsx(Ee,{className:"absolute left-3 top-3 h-4 w-4 text-muted-foreground"}),e.jsx(A,{placeholder:"Rechercher un produit ou service...",className:"pl-9",onChange:s=>me(s.target.value)})]})]})}),e.jsx(U,{className:"p-0",children:e.jsxs(Fe,{defaultValue:"produits",className:"w-full",children:[e.jsx("div",{className:"px-6",children:e.jsxs(ke,{className:"w-full",children:[e.jsx(K,{value:"produits",className:"flex-1",children:"Produits"}),e.jsx(K,{value:"services",className:"flex-1",children:"Services"})]})}),e.jsx(W,{value:"produits",className:"m-0",children:e.jsx(D,{className:"h-[500px] px-6 py-4",children:(T==null?void 0:T.length)>0?e.jsx("div",{className:"border rounded-lg",children:e.jsxs(Y,{children:[e.jsx(Z,{children:e.jsxs(k,{children:[e.jsx(j,{className:"w-[200px]",children:"Produit"}),e.jsx(j,{children:"Stock"}),e.jsx(j,{children:"Prix"}),e.jsx(j,{className:"text-right",children:"Actions"})]})}),e.jsx(ee,{children:T.map(s=>e.jsxs(k,{className:s.stock_disponible<=0?"opacity-60":"",children:[e.jsx(f,{className:"font-medium",children:s.name}),e.jsx(f,{children:e.jsx(b,{variant:s.stock_disponible>0?"success":"destructive",children:s.stock_disponible})}),e.jsx(f,{children:new Intl.NumberFormat("fr-FR",{style:"currency",currency:"USD"}).format(s.prix_vente).replace("$US","$ ")}),e.jsx(f,{className:"text-right",children:e.jsxs(N,{size:"sm",variant:"secondary",onClick:()=>H(s,"produit"),disabled:s.stock_disponible<=0,children:[e.jsx(se,{className:"h-4 w-4 mr-2"}),"Ajouter"]})})]},s.id))})]})}):e.jsx("div",{className:"text-center py-8",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aucun produit trouvé"})})})}),e.jsx(W,{value:"services",className:"m-0",children:e.jsx(D,{className:"h-[500px] px-6 py-4",children:(C==null?void 0:C.length)>0?e.jsx("div",{className:"border rounded-lg",children:e.jsxs(Y,{children:[e.jsx(Z,{children:e.jsxs(k,{children:[e.jsx(j,{className:"w-[200px]",children:"Service"}),e.jsx(j,{children:"Durée"}),e.jsx(j,{children:"Prix"}),e.jsx(j,{className:"text-right",children:"Actions"})]})}),e.jsx(ee,{children:C.map(s=>e.jsxs(k,{children:[e.jsx(f,{className:"font-medium",children:e.jsxs("div",{children:[s.name,s.description&&e.jsx("p",{className:"text-sm text-muted-foreground mt-1 line-clamp-1",children:s.description.slice(0,20)+"..."})]})}),e.jsx(f,{children:e.jsxs(b,{variant:"outline",children:[s.duree_minutes," min"]})}),e.jsx(f,{children:new Intl.NumberFormat("fr-FR",{style:"currency",currency:"USD"}).format(s.prix).replace("$US","$ ")}),e.jsx(f,{className:"text-right",children:e.jsxs(N,{size:"sm",variant:"secondary",onClick:()=>H(s,"service"),children:[e.jsx(se,{className:"h-4 w-4 mr-2"}),"Ajouter"]})})]},s.id))})]})}):e.jsx("div",{className:"text-center py-8",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aucun service trouvé"})})})})]})})]})]}),e.jsx("div",{className:"lg:col-span-4 space-y-6",children:e.jsxs($,{className:"flex flex-col",children:[e.jsxs(X,{className:"pb-3 flex items-center justify-between",children:[e.jsxs(J,{className:"flex items-center",children:[e.jsx(te,{className:"h-5 w-5 mr-2"}),"Panier (",i.items.length,")"]}),i.items.length>0&&e.jsxs(N,{size:"sm",variant:"destructive",onClick:xe,disabled:!F,children:[e.jsx(ze,{className:"h-4 w-4 mr-2"}),"Réinitialiser"]})]}),e.jsx(U,{children:e.jsx(D,{className:"flex-1 max-h-[350px] pr-4 overflow-y-auto",children:i.items.length>0?e.jsx("div",{className:"space-y-2",children:i.items.map((s,t)=>e.jsx($,{className:"overflow-hidden p-1",children:e.jsxs(U,{className:"p-1",children:[e.jsxs("div",{className:"flex justify-between items-start mb-3",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium",children:s.nom}),e.jsxs("div",{className:"flex gap-1 mt-1",children:[e.jsx(b,{variant:s.type==="produit"?"default":"secondary",children:s.type==="produit"?"Produit":"Service"}),s.id&&e.jsx(b,{variant:"outline",className:"text-xs",children:"Original"})]})]}),e.jsx(N,{variant:"ghost",size:"sm",disabled:!F,onClick:()=>de(t),children:e.jsx(Ie,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(q,{className:"text-xs",children:"Quantité"}),e.jsx(A,{type:"number",min:"1",max:s.type==="produit"?s.stock_disponible:void 0,value:s.quantite,onChange:n=>M(t,"quantite",parseInt(n.target.value)),className:"w-full"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(q,{className:"text-xs",children:"Prix unitaire"}),e.jsx(A,{type:"number",step:"1",value:s.prix_unitaire,onChange:n=>M(t,"prix_unitaire",parseFloat(n.target.value)),className:"w-full"})]})]}),e.jsxs("div",{className:"mt-3 flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Sous-total"}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("fr-FR",{style:"currency",currency:"USD"}).format(s.montant_total).replace("$US","$ ")})]})]})},t))}):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(te,{className:"h-8 w-8 mx-auto text-muted-foreground"}),e.jsx("p",{className:"mt-2 text-sm text-muted-foreground",children:"Votre panier est vide"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Ajoutez des produits ou services"})]})})}),i.items.length>0&&e.jsxs(Ce,{className:"flex flex-col border-t mt-auto",children:[e.jsxs("div",{className:"w-full space-y-3 py-3",children:[(()=>{const s=pe();return e.jsxs(e.Fragment,{children:[s.totalProduitsHT>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"Produits (HT)"}),e.jsx("span",{children:new Intl.NumberFormat("fr-FR",{style:"currency",currency:"USD"}).format(s.totalProduitsHT).replace("$US","$ ")})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{children:["TVA (",(R*100).toFixed(0),"%)"]}),e.jsx("span",{children:new Intl.NumberFormat("fr-FR",{style:"currency",currency:"USD"}).format(s.tvaProduitsAmount).replace("$US","$ ")})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"Produits (TTC)"}),e.jsx("span",{children:new Intl.NumberFormat("fr-FR",{style:"currency",currency:"USD"}).format(s.totalProduitsTTC).replace("$US","$ ")})]})]}),s.totalServices>0&&e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"Services"}),e.jsx("span",{children:new Intl.NumberFormat("fr-FR",{style:"currency",currency:"USD"}).format(s.totalServices).replace("$US","$ ")})]}),e.jsxs("div",{className:"flex justify-between font-medium",children:[e.jsx("span",{children:"Sous-total"}),e.jsx("span",{children:new Intl.NumberFormat("fr-FR",{style:"currency",currency:"USD"}).format(s.sousTotal).replace("$US","$ ")})]})]})})(),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(q,{htmlFor:"mode_paiement",children:"Mode de paiement"}),e.jsxs(be,{value:i.mode_paiement,onValueChange:s=>h("mode_paiement",s),children:[e.jsx(Se,{children:e.jsx(ye,{placeholder:"Sélectionnez un mode de paiement"})}),e.jsx(we,{children:ie.map(s=>e.jsx(Te,{value:s,children:s.charAt(0).toUpperCase()+s.slice(1)},s))})]})]}),e.jsx(Pe,{}),e.jsxs("div",{className:"flex justify-between font-bold text-lg",children:[e.jsx("span",{children:"Total"}),e.jsx("span",{children:new Intl.NumberFormat("fr-FR",{style:"currency",currency:"USD"}).format(i.montant_total).replace("$US","$ ")})]})]}),e.jsx("div",{className:"flex",children:e.jsx(qe,{onClientSelected:s=>{le(s),h("client_id",s.id.toString())},currentClientId:i.client_id,clients:re})}),e.jsx(N,{className:"w-full mt-2",type:"submit",onClick:ue,disabled:E||i.items.length===0||!i.client_id,children:E?"Modification...":"Enregistrer les modifications"}),w&&e.jsxs("div",{className:"w-full space-y-1 py-3 bg-muted/50 p-3 rounded-md mt-2",children:[e.jsx("p",{className:"font-medium",children:"Client sélectionné:"}),e.jsx("p",{children:w.name}),w.telephone&&e.jsx("p",{className:"text-sm",children:w.telephone})]})]})]})})]})]})]})}export{Ls as default};
